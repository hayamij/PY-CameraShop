{% extends 'admin_base.html' %}

{% block title %}Qu·∫£n l√Ω ƒë∆°n h√†ng - Camera Shop Admin{% endblock %}

{% block admin_content %}
<div class="admin-header">
    <h1>üì¶ Qu·∫£n l√Ω ƒë∆°n h√†ng</h1>
    <p>Danh s√°ch v√† qu·∫£n l√Ω t·∫•t c·∫£ ƒë∆°n h√†ng</p>
</div>

<div class="filter-bar">
    <select id="statusFilter" onchange="loadOrders()" class="input">
        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
        <option value="PENDING">Ch·ªù x·ª≠ l√Ω</option>
        <option value="SHIPPING">ƒêang giao</option>
        <option value="COMPLETED">Ho√†n th√†nh</option>
        <option value="CANCELLED">ƒê√£ h·ªßy</option>
    </select>
</div>

<div class="admin-section">
    <div id="loadingIndicator" class="loading">
        <div class="spinner"></div>
        <p style="color: #666;">ƒêang t·∫£i ƒë∆°n h√†ng...</p>
    </div>

    <div id="ordersList" class="orders-list hidden">
        <!-- Orders will be loaded here -->
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let orders = [];

async function loadOrders() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const ordersList = document.getElementById('ordersList');
    
    try {
        // Show loading
        loadingIndicator.classList.remove('hidden');
        ordersList.classList.add('hidden');
        
        const status = document.getElementById('statusFilter').value;
        const url = status ? `/api/admin/orders?status=${status}` : '/api/admin/orders';
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            orders = data.orders || [];
            renderOrders();
            
            // Hide loading, show orders
            loadingIndicator.classList.add('hidden');
            ordersList.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading orders:', error);
        loadingIndicator.classList.add('hidden');
        showAlert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng', 'error');
    }
}

function renderOrders() {
    const list = document.getElementById('ordersList');
    
    if (orders.length === 0) {
        list.innerHTML = '<p style="text-align: center; padding: 40px;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</p>';
        return;
    }
    
    list.innerHTML = orders.map(order => `
        <div class="order-card">
            <div class="order-header">
                <div>
                    <strong>ƒê∆°n h√†ng #${order.order_id || order.orderId}</strong>
                    <span class="order-date">${new Date(order.order_date || order.orderDate).toLocaleDateString('vi-VN')}</span>
                </div>
                <span class="order-status status-${(order.status || order.order_status || '').toLowerCase()}">${getStatusText(order.status || order.order_status)}</span>
            </div>
            <div class="order-body">
                <p>Kh√°ch h√†ng: ${order.customer_name || order.customerName || 'N/A'}</p>
                <p>T·ªïng ti·ªÅn: ${formatCurrency(order.total_amount || order.totalAmount)}</p>
            </div>
            <div class="order-actions">
                <button onclick="viewOrder(${order.order_id || order.orderId})" class="btn-view">Xem chi ti·∫øt</button>
                <select onchange="updateOrderStatus(${order.order_id || order.orderId}, this.value)" class="status-select">
                    <option value="">C·∫≠p nh·∫≠t tr·∫°ng th√°i</option>
                    <option value="SHIPPING">ƒêang giao</option>
                    <option value="COMPLETED">Ho√†n th√†nh</option>
                    <option value="CANCELLED">H·ªßy</option>
                </select>
            </div>
        </div>
    `).join('');
}

function getStatusText(status) {
    const statusMap = {
        'PENDING': 'Ch·ªù x·ª≠ l√Ω',
        'SHIPPING': 'ƒêang giao',
        'COMPLETED': 'Ho√†n th√†nh',
        'CANCELLED': 'ƒê√£ h·ªßy'
    };
    return statusMap[status] || status;
}

function viewOrder(orderId) {
    window.location.href = `/orders/${orderId}`;
}

async function updateOrderStatus(orderId, newStatus) {
    if (!newStatus) return;
    
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng?')) return;
    
    try {
        const response = await fetch(`/api/admin/orders/${orderId}/status`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        
        if (data.success || response.ok) {
            showToast('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!', 'success');
            loadOrders();
        } else {
            showToast(data.errorMessage || 'C√≥ l·ªói x·∫£y ra', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('L·ªói k·∫øt n·ªëi', 'error');
    }
}

window.onload = loadOrders;
</script>
{% endblock %}
