{% extends "admin-base.html" %}

{% block title %}Order Management - Admin{% endblock %}

{% block content %}
<div class="admin-page">
    <!-- Page Header -->
    <div class="admin-page-header">
        <h1 class="admin-page-title">Order Management</h1>
        <div class="admin-page-actions">
            <button class="btn btn-primary" onclick="showCreateOrderModal()">ADD ORDER</button>
            <button class="btn btn-outline" id="refreshBtn">üîÑ REFRESH</button>
        </div>
    </div>

    <!-- Filters -->
    <div class="admin-filters">
        <div class="filters-grid">
            <div class="form-group">
                <label for="searchInput">SEARCH</label>
                <input type="text" id="searchInput" placeholder="Search by order ID or user email..." class="form-control">
            </div>
            <div class="form-group">
                <label for="statusFilter">STATUS</label>
                <select id="statusFilter" class="form-control" onchange="filterOrders(this.value)">
                    <option value="">All Statuses</option>
                    <option value="CHO_XAC_NHAN">Pending</option>
                    <option value="DANG_GIAO">Shipping</option>
                    <option value="HOAN_THANH">Completed</option>
                    <option value="DA_HUY">Cancelled</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="admin-table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ORDER ID</th>
                    <th>USER</th>
                    <th>ITEMS</th>
                    <th>TOTAL</th>
                    <th>PAYMENT</th>
                    <th>STATUS</th>
                    <th>DATE</th>
                    <th>ACTIONS</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                <tr class="loading-row">
                    <td colspan="8">Loading orders...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Order Detail Modal -->
<div id="orderModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="modalTitle">ORDER DETAIL</h3>
            <button class="btn-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="orderDetail">
            <!-- Order detail will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal()">CLOSE</button>
        </div>
    </div>
</div>

<!-- Create Order Modal -->
<div id="createOrderModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3>CREATE ORDER</h3>
            <button class="btn-close" onclick="closeCreateOrderModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createOrderForm">
                <div class="form-group">
                    <label>CUSTOMER EMAIL *</label>
                    <input type="email" id="orderCustomerEmail" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>CUSTOMER PHONE *</label>
                    <input type="text" id="orderCustomerPhone" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>SHIPPING ADDRESS *</label>
                    <textarea id="orderShippingAddress" class="form-control" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>PAYMENT METHOD *</label>
                    <select id="orderPaymentMethod" class="form-control" required>
                        <option value="">SELECT PAYMENT METHOD</option>
                        <option value="TIEN_MAT">CASH</option>
                        <option value="BANK_TRANSFER">BANK TRANSFER</option>
                        <option value="CREDIT_CARD">CREDIT CARD</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ORDER NOTES</label>
                    <textarea id="orderNotes" class="form-control" rows="2"></textarea>
                </div>
                
                <div class="border-top pt-lg mt-lg">
                    <div class="d-flex justify-between align-center mb-md">
                        <p class="font-weight-bold text-uppercase">ORDER ITEMS</p>
                        <button type="button" class="btn btn-outline btn-sm" onclick="addOrderItem()">ADD ITEM</button>
                    </div>
                    <div id="orderItemsList">
                        <!-- Order items will be added here -->
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeCreateOrderModal()">CANCEL</button>
            <button class="btn btn-primary" onclick="createOrder()">CREATE ORDER</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

let currentStatus = '';

async function loadOrders() {
    try {
        showLoading();
        const params = { page: 1, per_page: 100 };
        if (currentStatus) params.status = currentStatus;
        
        const response = await API.admin.orders.list(params);
        hideLoading();
        
        if (response.success) {
            displayOrders(response.orders);
        } else {
            showAlert(response.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert(error.message, 'error');
    }
}

function displayOrders(orders) {
    const tbody = document.getElementById('ordersTableBody');
    
    if (orders.length === 0) {
        tbody.innerHTML = `
            <tr class="empty-state">
                <td colspan="8">
                    <div class="empty-state-icon">üìù</div>
                    <div class="empty-state-text">No orders found</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = orders.map(order => {
        const statusMap = {
            'CHO_XAC_NHAN': 'pending',
            'DANG_GIAO': 'shipping',
            'HOAN_THANH': 'completed',
            'DA_HUY': 'cancelled'
        };
        const statusText = {
            'CHO_XAC_NHAN': 'Pending',
            'DANG_GIAO': 'Shipping',
            'HOAN_THANH': 'Completed',
            'DA_HUY': 'Cancelled'
        };
        
        return `
        <tr>
            <td><strong>#${order.order_id}</strong></td>
            <td>${escapeHtml(order.customer_email || order.customer_name || 'Guest')}</td>
            <td>${order.item_count || 0} items</td>
            <td><strong>${parseFloat(order.total_amount || 0).toLocaleString('vi-VN')}</strong></td>
            <td>${(order.payment_method || '').replace('_', ' ')}</td>
            <td>
                <span class="status-badge ${statusMap[order.status] || 'pending'}">
                    ${statusText[order.status] || order.status}
                </span>
            </td>
            <td>${formatDateTime(order.order_date)}</td>
            <td>
                <div class="table-actions">
                    <button class="btn-table" onclick="viewOrderDetail(${order.order_id})">
                        View
                    </button>
                    ${order.status === 'CHO_XAC_NHAN' ? `
                        <button class="btn-table" onclick="updateOrderStatus(${order.order_id}, 'DANG_GIAO')">
                            Ship
                        </button>
                    ` : ''}
                    ${order.status === 'DANG_GIAO' ? `
                        <button class="btn-table" onclick="updateOrderStatus(${order.order_id}, 'HOAN_THANH')">
                            Complete
                        </button>
                    ` : ''}
                    <button class="btn-table btn-danger" onclick="deleteOrder(${order.order_id})">
                        Delete
                    </button>
                </div>
            </td>
        </tr>
    `;
    }).join('');
}

function filterOrders(status) {
    currentStatus = status;
    loadOrders();
}

async function viewOrderDetail(orderId) {
    try {
        showLoading();
        const response = await API.orders.getDetail(orderId);
        hideLoading();
        
        if (response.success) {
            const order = response.order;
            document.getElementById('orderDetail').innerHTML = `
                <div class="mb-lg">
                    <div class="grid grid-3 gap-lg">
                        <div>
                            <p class="font-weight-bold text-uppercase mb-sm">ORDER DATE</p>
                            <p>${formatDate(order.order_date)}</p>
                        </div>
                        <div>
                            <p class="font-weight-bold text-uppercase mb-sm">STATUS</p>
                            <p class="text-uppercase">${order.status}</p>
                        </div>
                        <div>
                            <p class="font-weight-bold text-uppercase mb-sm">PAYMENT METHOD</p>
                            <p>${order.payment_method.replace('_', ' ')}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-lg border-top pt-lg">
                    <div class="grid grid-2 gap-lg">
                        <div>
                            <p class="font-weight-bold text-uppercase mb-sm">CUSTOMER</p>
                            <p>${order.customer_email}</p>
                        </div>
                        <div>
                            <p class="font-weight-bold text-uppercase mb-sm">PHONE</p>
                            <p>${order.customer_phone}</p>
                        </div>
                        <div>
                            <p class="font-weight-bold text-uppercase mb-sm">SHIPPING ADDRESS</p>
                            <p>${order.shipping_address}</p>
                        </div>
                    </div>
                </div>
                
                <div class="border-top pt-lg">
                    <p class="font-weight-bold text-uppercase mb-md">ORDER ITEMS</p>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>PRODUCT</th>
                                <th>QUANTITY</th>
                                <th>UNIT PRICE</th>
                                <th>SUBTOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td>${item.product_name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${formatCurrency(item.unit_price, 'USD')}</td>
                                    <td class="font-weight-bold">${formatCurrency(item.subtotal, 'USD')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr class="border-top">
                                <td colspan="3" class="text-right font-weight-bold">SUBTOTAL:</td>
                                <td class="font-weight-bold">${formatCurrency(order.subtotal, 'USD')}</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="text-right font-weight-bold">TAX:</td>
                                <td class="font-weight-bold">${formatCurrency(order.tax, 'USD')}</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="text-right font-weight-bold">SHIPPING:</td>
                                <td class="font-weight-bold">${formatCurrency(order.shipping_fee, 'USD')}</td>
                            </tr>
                            <tr class="border-top">
                                <td colspan="3" class="text-right font-weight-bold" style="font-size: var(--font-size-lg);">TOTAL:</td>
                                <td class="font-weight-bold" style="font-size: var(--font-size-lg);">${formatCurrency(order.total_amount, 'USD')}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            document.getElementById('orderModal').style.display = 'block';
        } else {
            showAlert(response.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert(error.message, 'error');
    }
}

async function updateOrderStatus(orderId, status) {
    if (!confirm(`Change order status to ${status}?`)) return;
    
    try {
        showLoading();
        const response = await API.admin.orders.updateStatus(orderId, status);
        hideLoading();
        
        if (response.success) {
            showAlert('Order status updated', 'success');
            loadOrders();
        } else {
            showAlert(response.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert(error.message, 'error');
    }
}

function closeModal() {
    document.getElementById('orderModal').style.display = 'none';
}

async function deleteOrder(orderId) {
    if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) return;
    
    try {
        showLoading();
        const response = await API.admin.orders.delete(orderId);
        hideLoading();
        
        if (response.success) {
            showAlert('Order deleted successfully', 'success');
            loadOrders();
        } else {
            showAlert(response.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert(error.message, 'error');
    }
}

let orderItemsCount = 0;

function showCreateOrderModal() {
    document.getElementById('createOrderForm').reset();
    document.getElementById('orderItemsList').innerHTML = '';
    orderItemsCount = 0;
    addOrderItem();
    document.getElementById('createOrderModal').style.display = 'block';
}

function closeCreateOrderModal() {
    document.getElementById('createOrderModal').style.display = 'none';
}

function addOrderItem() {
    orderItemsCount++;
    const itemHtml = `
        <div class="card mb-md" id="orderItem${orderItemsCount}">
            <div class="card-body">
                <div class="d-flex justify-between align-center mb-md">
                    <p class="font-weight-bold">ITEM #${orderItemsCount}</p>
                    <button type="button" class="btn btn-outline btn-sm" onclick="removeOrderItem(${orderItemsCount})">REMOVE</button>
                </div>
                <div class="grid grid-3 gap-md">
                    <div class="form-group">
                        <label>PRODUCT ID *</label>
                        <input type="number" class="form-control item-product-id" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>QUANTITY *</label>
                        <input type="number" class="form-control item-quantity" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label>UNIT PRICE (USD) *</label>
                        <input type="number" class="form-control item-price" min="0" step="0.01" required>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('orderItemsList').insertAdjacentHTML('beforeend', itemHtml);
}

function removeOrderItem(itemId) {
    const item = document.getElementById('orderItem' + itemId);
    if (item) {
        item.remove();
    }
}

async function createOrder() {
    const form = document.getElementById('createOrderForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Collect order items
    const items = [];
    const itemElements = document.querySelectorAll('#orderItemsList .card');
    
    if (itemElements.length === 0) {
        showAlert('Please add at least one item to the order', 'error');
        return;
    }
    
    itemElements.forEach(itemEl => {
        const productId = parseInt(itemEl.querySelector('.item-product-id').value);
        const quantity = parseInt(itemEl.querySelector('.item-quantity').value);
        const unitPrice = parseFloat(itemEl.querySelector('.item-price').value);
        
        if (productId && quantity && unitPrice) {
            items.push({
                product_id: productId,
                quantity: quantity,
                unit_price: unitPrice
            });
        }
    });
    
    if (items.length === 0) {
        showAlert('Please fill in all item details', 'error');
        return;
    }
    
    const orderData = {
        customer_email: document.getElementById('orderCustomerEmail').value,
        customer_phone: document.getElementById('orderCustomerPhone').value,
        shipping_address: document.getElementById('orderShippingAddress').value,
        payment_method: document.getElementById('orderPaymentMethod').value,
        notes: document.getElementById('orderNotes').value || '',
        items: items
    };
    
    try {
        showLoading();
        const response = await API.admin.orders.create(orderData);
        hideLoading();
        
        if (response.success) {
            showAlert('Order created successfully', 'success');
            closeCreateOrderModal();
            loadOrders();
        } else {
            showAlert(response.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert(error.message, 'error');
    }
}

window.filterOrders = filterOrders;
window.viewOrderDetail = viewOrderDetail;
// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Event listeners
document.getElementById('refreshBtn').addEventListener('click', loadOrders);

// Make functions global
window.updateOrderStatus = updateOrderStatus;
window.closeModal = closeModal;
window.deleteOrder = deleteOrder;
window.showCreateOrderModal = showCreateOrderModal;
window.closeCreateOrderModal = closeCreateOrderModal;
window.addOrderItem = addOrderItem;
window.removeOrderItem = removeOrderItem;
window.createOrder = createOrder;

loadOrders();

});
</script>
{% endblock %}
