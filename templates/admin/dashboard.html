{% extends "admin-base.html" %}

{% block title %}Dashboard - Admin{% endblock %}

{% block content %}
<div class="admin-page">
    <!-- Page Header -->
    <div class="admin-page-header">
        <h1 class="admin-page-title">Dashboard</h1>
        <div class="admin-page-actions">
            <button class="btn btn-outline" id="refreshBtn">REFRESH</button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px;">
        <div style="background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Total Users</div>
            <div style="font-size: 2.5rem; font-weight: 700; color: #000;" id="totalUsers">-</div>
        </div>
        <div style="background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Total Products</div>
            <div style="font-size: 2.5rem; font-weight: 700; color: #000;" id="totalProducts">-</div>
        </div>
        <div style="background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Total Orders</div>
            <div style="font-size: 2.5rem; font-weight: 700; color: #000;" id="totalOrders">-</div>
        </div>
        <div style="background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Pending Orders</div>
            <div style="font-size: 2.5rem; font-weight: 700; color: #fff3cd;" id="pendingOrders">-</div>
        </div>
    </div>

    <!-- Data Visualization Charts (Plotly) -->
    <div style="margin-bottom: 32px;">
        <h2 style="font-size: 1.3rem; font-weight: 700; text-transform: uppercase; margin-bottom: 24px; color: #000;">üìä Bi·ªÉu ƒê·ªì Th·ªëng K√™</h2>
        
        <!-- Row 1: Revenue & Order Status -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px; margin-bottom: 24px;">
            <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div id="revenueChart"></div>
            </div>
            <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div id="statusChart"></div>
            </div>
        </div>
        
        <!-- Row 2: Category & User Registration -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px;">
            <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div id="categoryChart"></div>
            </div>
            <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div id="userChart"></div>
            </div>
        </div>
    </div>

    <!-- Recent Orders and Low Stock -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px;">
        <!-- Recent Orders -->
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="font-size: 1.2rem; font-weight: 700; text-transform: uppercase; margin: 0;">Recent Orders</h2>
                <a href="/admin/orders" class="btn btn-outline btn-sm">View All</a>
            </div>
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ORDER ID</th>
                            <th>USER</th>
                            <th>TOTAL</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="recentOrders">
                        <tr class="loading-row">
                            <td colspan="4">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Low Stock Products -->
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="font-size: 1.2rem; font-weight: 700; text-transform: uppercase; margin: 0;">Low Stock Products</h2>
                <a href="/admin/products" class="btn btn-outline btn-sm">View All</a>
            </div>
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>PRODUCT</th>
                            <th>STOCK</th>
                            <th>PRICE</th>
                        </tr>
                    </thead>
                    <tbody id="lowStockProducts">
                        <tr class="loading-row">
                            <td colspan="3">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart Data from Backend -->
<script id="chartData" type="application/json">
{
    "revenue": {{ revenue_chart | tojson | safe if revenue_chart else 'null' }},
    "status": {{ status_chart | tojson | safe if status_chart else 'null' }},
    "category": {{ category_chart | tojson | safe if category_chart else 'null' }},
    "user": {{ user_chart | tojson | safe if user_chart else 'null' }}
}
</script>

<script>
// Load dashboard data
async function loadDashboard() {
    try {
        showLoading();
        console.log('Loading dashboard data...');
        
        const [usersRes, productsRes, ordersRes] = await Promise.all([
            API.admin.users.list({ page: 1, per_page: 100 }),
            API.products.list({ page: 1, per_page: 100 }),
            API.admin.orders.list({ page: 1, per_page: 100 })
        ]);
        
        console.log('Data loaded:', { usersRes, productsRes, ordersRes });
        hideLoading();
        
        // Update statistics - users API returns nested data
        if (usersRes.success && usersRes.data && usersRes.data.pagination) {
            const totalUsers = usersRes.data.pagination.total_users || usersRes.data.pagination.total || 0;
            document.getElementById('totalUsers').textContent = totalUsers;
        }
        
        // Products API returns flat structure
        if (productsRes.success) {
            document.getElementById('totalProducts').textContent = productsRes.total_products || 0;
            displayLowStockProducts(productsRes.products || []);
        }
        
        // Orders API returns flat structure
        if (ordersRes.success) {
            document.getElementById('totalOrders').textContent = ordersRes.total_orders || 0;
            const pending = (ordersRes.orders || []).filter(o => o.status === 'CHO_XAC_NHAN').length;
            document.getElementById('pendingOrders').textContent = pending;
            displayRecentOrders((ordersRes.orders || []).slice(0, 5));
        }
    } catch (error) {
        console.error('Dashboard Error:', error);
        hideLoading();
        showAlert('Failed to load dashboard: ' + (error.message || 'Unknown error'), 'error');
        
        // Display error in tables
        document.getElementById('recentOrders').innerHTML = `
            <tr class="error-state">
                <td colspan="4" style="color: #dc3545; text-align: center;">
                    Failed to load data: ${error.message || 'Unknown error'}
                </td>
            </tr>
        `;
        document.getElementById('lowStockProducts').innerHTML = `
            <tr class="error-state">
                <td colspan="3" style="color: #dc3545; text-align: center;">
                    Failed to load data: ${error.message || 'Unknown error'}
                </td>
            </tr>
        `;
    }
}

// Display recent orders
function displayRecentOrders(orders) {
    const tbody = document.getElementById('recentOrders');
    
    if (orders.length === 0) {
        tbody.innerHTML = `
            <tr class="empty-state">
                <td colspan="4">
                    <div class="empty-state-text">No orders yet</div>
                </td>
            </tr>
        `;
        return;
    }
    
    const statusMap = {
        'CHO_XAC_NHAN': 'pending',
        'DANG_GIAO': 'shipping',
        'HOAN_THANH': 'completed',
        'DA_HUY': 'cancelled'
    };
    const statusText = {
        'CHO_XAC_NHAN': 'Pending',
        'DANG_GIAO': 'Shipping',
        'HOAN_THANH': 'Completed',
        'DA_HUY': 'Cancelled'
    };
    
    tbody.innerHTML = orders.map(order => `
        <tr>
            <td><strong>#${order.order_id}</strong></td>
            <td>${escapeHtml(order.customer_email || order.customer_name || 'Guest')}</td>
            <td><strong>${parseFloat(order.total_amount || 0).toLocaleString('vi-VN')}</strong></td>
            <td>
                <span class="status-badge ${statusMap[order.status] || 'pending'}">
                    ${statusText[order.status] || order.status}
                </span>
            </td>
        </tr>
    `).join('');
}

// Display low stock products
function displayLowStockProducts(products) {
    const lowStock = products.filter(p => p.stock_quantity < 10).slice(0, 5);
    const tbody = document.getElementById('lowStockProducts');
    
    if (lowStock.length === 0) {
        tbody.innerHTML = `
            <tr class="empty-state">
                <td colspan="3">
                    <div class="empty-state-text">All products in stock</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = lowStock.map(product => `
        <tr>
            <td>${escapeHtml(product.name)}</td>
            <td style="font-weight: 700; color: ${product.stock_quantity < 5 ? '#dc3545' : '#856404'}">
                ${product.stock_quantity}
            </td>
            <td><strong>${parseFloat(product.price || 0).toLocaleString('vi-VN')}</strong></td>
        </tr>
    `).join('');
}

// Utility function
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Render Plotly Charts
function renderCharts() {
    try {
        // Get chart data from script tag
        const chartDataElement = document.getElementById('chartData');
        if (!chartDataElement) {
            console.warn('No chart data found');
            return;
        }
        
        const chartData = JSON.parse(chartDataElement.textContent);
        
        // Revenue Chart
        if (chartData.revenue) {
            const revenueData = JSON.parse(chartData.revenue);
            Plotly.newPlot('revenueChart', revenueData.data, revenueData.layout, {responsive: true});
        }
        
        // Status Chart
        if (chartData.status) {
            const statusData = JSON.parse(chartData.status);
            Plotly.newPlot('statusChart', statusData.data, statusData.layout, {responsive: true});
        }
        
        // Category Chart
        if (chartData.category) {
            const categoryData = JSON.parse(chartData.category);
            Plotly.newPlot('categoryChart', categoryData.data, categoryData.layout, {responsive: true});
        }
        
        // User Chart
        if (chartData.user) {
            const userData = JSON.parse(chartData.user);
            Plotly.newPlot('userChart', userData.data, userData.layout, {responsive: true});
        }
    } catch (error) {
        console.error('Error rendering charts:', error);
    }
}

// Event listeners
document.getElementById('refreshBtn').addEventListener('click', function() {
    location.reload();
});

// Initial load
loadDashboard();
renderCharts();
</script>
{% endblock %}
