{% extends "admin-base.html" %}

{% block title %}User Management - Admin{% endblock %}

{% block content %}
<div class="admin-page">
    <!-- Page Header -->
    <div class="admin-page-header">
        <h1 class="admin-page-title">User Management</h1>
        <div class="admin-page-actions">
            <button class="btn btn-primary" onclick="showCreateUserModal()">ADD USER</button>
            <button class="btn btn-outline" id="refreshBtn">ðŸ”„ REFRESH</button>
        </div>
    </div>

    <!-- Filters -->
    <div class="admin-filters">
        <div class="filters-grid">
            <div class="form-group">
                <label for="searchInput">SEARCH</label>
                <input type="text" id="searchInput" placeholder="Search by name or email..." class="form-control">
            </div>
            <div class="form-group">
                <label for="roleFilter">ROLE</label>
                <select id="roleFilter" class="form-control">
                    <option value="">All Roles</option>
                    <option value="CUSTOMER">Customer</option>
                    <option value="ADMIN">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label for="statusFilter">STATUS</label>
                <select id="statusFilter" class="form-control">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="admin-table-container">
        <table class="admin-table" id="usersTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>NAME</th>
                    <th>EMAIL</th>
                    <th>PHONE</th>
                    <th>ROLE</th>
                    <th>STATUS</th>
                    <th>CREATED</th>
                    <th>ACTIONS</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <tr class="loading-row">
                    <td colspan="8">Loading users...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div id="userModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="userModalTitle">CREATE USER</h3>
            <button class="btn-close" onclick="closeUserModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <label>USERNAME *</label>
                    <input type="text" id="username" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>EMAIL *</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                
                <div class="form-group" id="passwordGroup">
                    <label>PASSWORD *</label>
                    <input type="password" id="password" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>FULL NAME *</label>
                    <input type="text" id="fullName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>PHONE NUMBER</label>
                    <input type="text" id="phoneNumber" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>ADDRESS</label>
                    <textarea id="address" class="form-control" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ROLE *</label>
                    <select id="role" class="form-control" required>
                        <option value="CUSTOMER">CUSTOMER</option>
                        <option value="ADMIN">ADMIN</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isActive" checked> ACTIVE
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeUserModal()">CANCEL</button>
            <button class="btn btn-primary" onclick="saveUser()">SAVE</button>
        </div>
    </div>
</div>

<!-- Change Role Modal -->
<div id="roleModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>CHANGE USER ROLE</h3>
            <button class="btn-close" onclick="closeRoleModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="roleUserId">
            <div class="form-group">
                <label>SELECT NEW ROLE</label>
                <select id="newRole" class="form-control">
                    <option value="CUSTOMER">CUSTOMER</option>
                    <option value="ADMIN">ADMIN</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeRoleModal()">CANCEL</button>
            <button class="btn btn-primary" onclick="saveRoleChange()">CHANGE ROLE</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let allUsers = [];
let filteredUsers = [];

// Load all users
async function loadUsers() {
    try {
        showLoading();
        const response = await API.admin.users.list({ per_page: 100 });
        // API returns nested: response.data.users
        allUsers = (response.data && response.data.users) || [];
        applyFilters();
        hideLoading();
    } catch (error) {
        console.error('Error loading users:', error);
        showAlert('Failed to load users: ' + (error.message || 'Unknown error'), 'error');
        hideLoading();
    }
}

// Apply filters
function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const roleFilter = document.getElementById('roleFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;

    filteredUsers = allUsers.filter(user => {
        const matchesSearch = !searchTerm || 
            (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) ||
            user.email.toLowerCase().includes(searchTerm);
        
        const matchesRole = !roleFilter || user.role === roleFilter;
        
        const matchesStatus = !statusFilter || 
            (statusFilter === 'active' && user.is_active) ||
            (statusFilter === 'inactive' && !user.is_active);
        
        return matchesSearch && matchesRole && matchesStatus;
    });

    renderUsers();
}

// Render users table
function renderUsers() {
    const tbody = document.getElementById('usersTableBody');
    
    if (filteredUsers.length === 0) {
        tbody.innerHTML = `
            <tr class="empty-state">
                <td colspan="8">
                    <div class="empty-state-icon">ðŸ‘¥</div>
                    <div class="empty-state-text">No users found</div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = filteredUsers.map(user => `
        <tr>
            <td>${user.user_id}</td>
            <td>${escapeHtml(user.full_name || '-')}</td>
            <td>${escapeHtml(user.email)}</td>
            <td>${user.phone_number || '-'}</td>
            <td><strong>${user.role}</strong></td>
            <td>
                <span class="status-badge ${user.is_active ? 'active' : 'inactive'}">
                    ${user.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>${formatDateTime(user.created_at)}</td>
            <td>
                <div class="table-actions">
                    <button class="btn-table" onclick='showEditUserModal(${JSON.stringify(user).replace(/'/g, "&apos;")})'>
                        Edit
                    </button>
                    <button class="btn-table btn-danger" onclick="deleteUser(${user.user_id})">
                        Delete
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Delete user
async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) return;

    try {
        showLoading();
        await API.admin.users.delete(userId);
        showAlert('User deleted successfully', 'success');
        await loadUsers();
    } catch (error) {
        console.error('Error deleting user:', error);
        showAlert('Failed to delete user: ' + (error.message || 'Unknown error'), 'error');
        hideLoading();
    }
}

// Create User Modal
function showCreateUserModal() {
    document.getElementById('userModalTitle').textContent = 'CREATE USER';
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('passwordGroup').style.display = 'block';
    document.getElementById('password').required = true;
    document.getElementById('userModal').style.display = 'block';
}

// Edit User Modal
function showEditUserModal(user) {
    document.getElementById('userModalTitle').textContent = 'EDIT USER';
    document.getElementById('userId').value = user.user_id;
    document.getElementById('username').value = user.username;
    document.getElementById('email').value = user.email;
    document.getElementById('fullName').value = user.full_name || '';
    document.getElementById('phoneNumber').value = user.phone_number || '';
    document.getElementById('address').value = user.address || '';
    document.getElementById('role').value = user.role;
    document.getElementById('isActive').checked = user.is_active;
    document.getElementById('passwordGroup').style.display = 'none';
    document.getElementById('password').required = false;
    document.getElementById('userModal').style.display = 'block';
}

function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
}

async function saveUser() {
    const userId = document.getElementById('userId').value;
    const isEdit = !!userId;
    
    const data = {
        username: document.getElementById('username').value,
        email: document.getElementById('email').value,
        full_name: document.getElementById('fullName').value,
        phone_number: document.getElementById('phoneNumber').value,
        address: document.getElementById('address').value,
        role: document.getElementById('role').value,
        is_active: document.getElementById('isActive').checked
    };
    
    if (!isEdit) {
        data.password = document.getElementById('password').value;
        if (!data.password) {
            showAlert('Password is required', 'error');
            return;
        }
    }
    
    try {
        showLoading();
        const response = isEdit 
            ? await API.admin.users.update(userId, data)
            : await API.admin.users.create(data);
        hideLoading();
        
        if (response.success) {
            showAlert(isEdit ? 'User updated successfully' : 'User created successfully', 'success');
            closeUserModal();
            loadUsers();
        } else {
            showAlert(response.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert(error.message, 'error');
    }
}

// Change Role Modal
function showChangeRoleModal(userId, currentRole) {
    document.getElementById('roleUserId').value = userId;
    document.getElementById('newRole').value = currentRole;
    document.getElementById('roleModal').style.display = 'block';
}

function closeRoleModal() {
    document.getElementById('roleModal').style.display = 'none';
}

async function saveRoleChange() {
    const userId = document.getElementById('roleUserId').value;
    const newRole = document.getElementById('newRole').value;
    
    try {
        showLoading();
        const response = await API.admin.users.changeRole(userId, newRole);
        hideLoading();
        
        if (response.success) {
            showAlert('Role changed successfully', 'success');
            closeRoleModal();
            loadUsers();
        } else {
            showAlert(response.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert(error.message, 'error');
    }
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Event listeners
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('roleFilter').addEventListener('change', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('refreshBtn').addEventListener('click', loadUsers);

// Make functions global
window.deleteUser = deleteUser;
window.showCreateUserModal = showCreateUserModal;
window.showEditUserModal = showEditUserModal;
window.closeUserModal = closeUserModal;
window.saveUser = saveUser;
window.showChangeRoleModal = showChangeRoleModal;
window.closeRoleModal = closeRoleModal;
window.saveRoleChange = saveRoleChange;

// Initial load
loadUsers();
</script>
{% endblock %}
