{% extends "base.html" %}

{% block title %}Manage Users - Camera Shop{% endblock %}

{% block content %}
<div class="mb-lg d-flex justify-between align-center">
    <h1>MANAGE USERS</h1>
    <a href="/admin/dashboard" class="btn btn-outline">‚Üê BACK TO DASHBOARD</a>
</div>

<div class="card mb-lg">
    <div class="card-body">
        <div class="d-flex gap-md">
            <input type="text" 
                   id="searchInput" 
                   placeholder="Search users by email or name..."
                   class="form-control"
                   style="flex: 1;">
            <select id="roleFilter" class="form-control" style="width: 200px;">
                <option value="">ALL ROLES</option>
                <option value="CUSTOMER">CUSTOMER</option>
                <option value="ADMIN">ADMIN</option>
            </select>
        </div>
    </div>
</div>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>USER ID</th>
                <th>EMAIL</th>
                <th>FULL NAME</th>
                <th>ROLE</th>
                <th>STATUS</th>
                <th>REGISTERED</th>
                <th>ACTIONS</th>
            </tr>
        </thead>
        <tbody id="usersTable">
            <tr>
                <td colspan="7" class="text-center">Loading...</td>
            </tr>
        </tbody>
    </table>
</div>

<div id="pagination" class="mt-lg text-center"></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

let currentPage = 1;
const pageSize = 20;
let currentRole = '';
let searchTimeout;

async function loadUsers() {
    try {
        showLoading();
        const params = { page: currentPage, per_page: pageSize };
        if (currentRole) params.role = currentRole;
        
        const response = await API.admin.users.list(params);
        hideLoading();
        
        if (response.success) {
            displayUsers(response.data.users);
            displayPagination(response.data.pagination.total, response.data.pagination.page, response.data.pagination.per_page);
        } else {
            showAlert(response.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert(error.message, 'error');
    }
}

function displayUsers(users) {
    const tbody = document.getElementById('usersTable');
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No users found</td></tr>';
        return;
    }
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>${user.user_id}</td>
            <td>${user.email}</td>
            <td>${user.full_name || '-'}</td>
            <td class="font-weight-bold">${user.role}</td>
            <td class="text-uppercase">${user.is_active ? 'ACTIVE' : 'INACTIVE'}</td>
            <td>${formatDate(user.created_at)}</td>
            <td>
                <div class="d-flex gap-sm">
                    <button class="btn btn-outline btn-sm" onclick="deleteUser(${user.user_id})">
                        DELETE
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function displayPagination(total, page, pageSize) {
    const totalPages = Math.ceil(total / pageSize);
    const container = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '<div class="d-flex justify-center gap-sm">';
    
    if (page > 1) {
        html += `<button class="btn btn-outline" onclick="changePage(${page - 1})">PREVIOUS</button>`;
    }
    
    for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
        html += `<button class="btn ${i === page ? 'btn-primary' : 'btn-outline'}" 
                         onclick="changePage(${i})">${i}</button>`;
    }
    
    if (page < totalPages) {
        html += `<button class="btn btn-outline" onclick="changePage(${page + 1})">NEXT</button>`;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
    
    try {
        showLoading();
        const response = await API.admin.users.delete(userId);
        hideLoading();
        
        if (response.success) {
            showAlert('User deleted successfully', 'success');
            loadUsers();
        } else {
            showAlert(response.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert(error.message, 'error');
    }
}

function changePage(page) {
    currentPage = page;
    loadUsers();
}

document.getElementById('roleFilter').addEventListener('change', (e) => {
    currentRole = e.target.value;
    currentPage = 1;
    loadUsers();
});

document.getElementById('searchInput').addEventListener('input', debounce((e) => {
    currentPage = 1;
    loadUsers();
}, 500));

window.deleteUser = deleteUser;
window.changePage = changePage;

loadUsers();

});
</script>
{% endblock %}
